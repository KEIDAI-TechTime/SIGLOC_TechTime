# 技術仕様（開発者向け）

このドキュメントは、システムの保守・改修を行う**開発者向け**の技術情報をまとめたものです。

---

## 技術スタック

| 項目 | 技術 |
|------|------|
| 開発言語 | Google Apps Script (JavaScript ES6相当) |
| UI基盤 | Google Spreadsheet |
| ドキュメント操作 | Google Docs API / Google Drive API |
| フォーム操作 | Google Forms API |
| ストレージ | Google Drive |
| バージョン管理 | GitHub |

---

## システムアーキテクチャ

### 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        Google Drive                             │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              プロジェクトフォルダ                        │   │
│  │                                                         │   │
│  │  ┌──────────────────┐    ┌──────────────────┐          │   │
│  │  │ SIGLOC-online    │    │ 事後レポート      │          │   │
│  │  │ 新期開始時       │    │ 作成システム      │          │   │
│  │  │ サポートシステム  │    │                  │          │   │
│  │  │ (.xlsx)          │    │ (.xlsx)          │          │   │
│  │  │                  │    │                  │          │   │
│  │  │ ┌────────────┐  │    │ ┌────────────┐   │          │   │
│  │  │ │Container   │  │    │ │Container   │   │          │   │
│  │  │ │Bound GAS   │  │    │ │Bound GAS   │   │          │   │
│  │  │ │(UI制御)    │  │    │ │(UI制御)    │   │          │   │
│  │  │ └─────┬──────┘  │    │ └─────┬──────┘   │          │   │
│  │  └───────┼──────────┘    └───────┼──────────┘          │   │
│  │          │                       │                     │   │
│  │          └───────────┬───────────┘                     │   │
│  │                      │                                 │   │
│  │                      ▼                                 │   │
│  │            ┌──────────────────┐                        │   │
│  │            │   GASプロジェクト │                        │   │
│  │            │   (Standalone)   │                        │   │
│  │            │                  │                        │   │
│  │            │   COIL Library   │                        │   │
│  │            │   ・ビジネスロジック                       │   │
│  │            │   ・共通処理     │                        │   │
│  │            └──────────────────┘                        │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              作業フォルダ (XXth_SIGLOC)                  │   │
│  │                                                         │   │
│  │  └── Online/                                            │   │
│  │      ├── SYSTEM/                                        │   │
│  │      ├── XXth_Student_WORKSPACE/                        │   │
│  │      │   ├── Personal/                                  │   │
│  │      │   ├── Materials/                                 │   │
│  │      │   └── Shared/                                    │   │
│  │      └── Google_Form/                                   │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## GASプロジェクト構成

### 新期開始時サポートシステム

```
SIGLOC-online新期開始時サポートシステム/
│
├── callApi.gs           # UI層 - ボタンクリック時の処理
│   ├── callCreateVariousFolder()
│   ├── callUpdateSystemFile()
│   ├── callUpdateGoogleForm()
│   ├── callUpdateStudentWorkTemplateFile()
│   ├── callUpdateMyCheckList()
│   ├── callCreateCompletionCertificate()
│   └── callTest*()      # 各テスト関数
│
└── (COILライブラリを参照)
```

### COILライブラリ（共通モジュール）

```
COIL Library/
│
├── 01_VariousFolder.gs              # フォルダ作成処理
├── 01_VariousFolderTest.gs          # フォルダ作成テスト
├── 02_SystemFile.gs                 # システムファイル更新
├── 02_SystemFileTest.gs             # システムファイルテスト
├── 03_GoogleForm.gs                 # Googleフォーム更新
├── 03_GoogleFormTest.gs             # Googleフォームテスト
├── 04_StudentWorkTemplateFile.gs    # テンプレート更新
├── 04_StudentWorkTemplateFileTest.gs
├── 05_MyCheckList.gs                # チェックリスト更新
├── 05_MyCheckListTest.gs
├── 06_CompletionCertificate.gs      # 修了証作成
├── 06_CompletionCertificateTest.gs
│
├── check.gs                         # 共通チェック処理
└── util.gs                          # ユーティリティ関数
```

### 事後レポート作成システム

```
事後レポート作成システム/
│
├── callApi.gs           # UI層
│   ├── callJapanese()
│   ├── callEnglish()
│   └── callCreateReport()
│
└── (COILライブラリを参照)

COIL Library/
└── reportCreateSystem/
    └── 01_Report.gs     # レポート作成ロジック
```

---

## 主要な処理フロー

### 各種フォルダ作成 (createVariousFolder)

```
1. 引数チェック
   └── thisTimeFolderId, thisTime, lastTimeFolderId, lastTime

2. フォルダ構造作成
   ├── Online/ を作成
   ├── Online/SYSTEM/ を作成
   ├── Online/XXth_Student_WORKSPACE/ を作成
   │   ├── Personal/
   │   ├── Materials/
   │   └── Shared/
   └── Online/Google_Form/ を作成

3. 前回フォルダからのコピー
   └── Materials等のファイルをコピー

4. リンク更新
   └── コピーしたファイル内のリンクを新しいIDに更新
```

### レポート作成 (createReport)

```
1. 初期設定
   ├── 日時フォーマット取得
   └── ファイル名決定 (FeedbackResult_XX_yyyyMMdd_HHmmss)

2. ベースファイルコピー
   └── copyFile(baseFileId, folderId, newFileName)

3. データ取得・加工
   └── DataColumnごとにループ
       ├── OutputType.GRAPH → aggregate() でグラフデータ集計
       ├── OutputType.GRAPH_MIX → aggregate() (カンマ区切り対応)
       ├── OutputType.GRAPH_COMMA → aggregate() (カンマ区切り)
       └── OutputType.TEXT → shuffle() でテキスト取得

4. ドキュメント出力
   └── updateDocFile(newFileId, values, lang)
       └── LangType.JP の場合は translate() で翻訳
```

---

## 技術的制約

### GASの制限

| 項目 | 制限値 |
|------|--------|
| 実行時間 | 6分（360秒） |
| スクリプトサイズ | 50MB |
| 1日のトリガー実行 | 90分 |
| URLフェッチ | 20,000回/日 |

### 自動更新できないもの

| 対象 | 理由 |
|------|------|
| スマートチップ | GAS APIで更新メソッドが提供されていない |
| Googleフォーム内のリンク | リッチテキスト非対応のためリンク特定不可 |
| 一部の埋め込みオブジェクト | APIでの操作が制限されている |

---

## 開発環境設定

### 必要なツール

| ツール | 用途 |
|--------|------|
| clasp | GASのローカル開発・デプロイ |
| Node.js | clasp実行環境 |
| Git | バージョン管理 |

### clasp設定手順

```bash
# claspインストール
npm install -g @google/clasp

# ログイン
clasp login

# プロジェクトクローン
clasp clone <スクリプトID>

# ソースプッシュ
clasp push

# ソースプル
clasp pull
```

### GitHub連携

- 3つのリポジトリで管理
  - SIGLOCサポートシステム用
  - 事後レポート作成システム用
  - 共通モジュール用

詳細 → `99_資料など/2_設置手順書/ソース改修方法/`

---

## デバッグ方法

### ログ出力

```javascript
// ログ出力関数
function outputLog(level, message) {
  // LogLevel: INFO, WARN, ERROR
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('log');
  sheet.appendRow([new Date(), level, message]);
}
```

### 実行ログ確認

1. Apps Scriptエディタを開く
2. 「実行」→「実行数」を選択
3. 該当の実行を選択してログを確認

---

## 詳細仕様書

| カテゴリ | 場所 |
|----------|------|
| UI仕様 | `99_資料など/1_ソフトウエア仕様書/ui/` |
| API仕様 | `99_資料など/1_ソフトウエア仕様書/api/` |
| システム構成 | `99_資料など/2_設置手順書/構成について/` |
| 開発手順 | `99_資料など/2_設置手順書/ソース改修方法/` |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025.10.20 | 第23回SIGLOC準備作業実施 |
| 2025.04.09 | 運用フロー整理 |
| 2025.03.27 | タスク完了管理ブックのシートクリア対応 |
| 2025.03.26 | 第21回SIGLOC準備作業実施 |
| 2025.02.27 | システム構成ドキュメント作成 |
